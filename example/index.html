<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raycast Engine Demo</title>
    <style>
        html, body {
            overflow: hidden;
        }

        body {
            background: #000000;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        canvas {
            position: absolute;
        }

        #display {
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        #status {
            width: 100%;
            height: 100%;
            z-index: 3;
        }

        #minimap {
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 4;
        }

        .info-ui {
            font-weight: bold;
            font-size: 10px;
            color: #FFFFFF;
            font-family: monospace;
            position: absolute;
            top: 2%;
            left: 2%;
        }

        .title-screen {
            z-index: 999;
            position: absolute;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            text-align: center;
            font-family: monospace;
            font-size: 48px;
            font-weight: bold;
            color: #FFFFFF;
        }

        .title-box {
            display: flex;
            justify-content: space-between;
            width: 100% !important;
            margin-left: 30%;
            margin-right: 30%;
        }

        .title-button {
            background-color: #00e2ff;
            color: #FFF;
            width: 45%;
            height: 2rem;
            border: none;
        }
    </style>
</head>
<body>
<div class="title-screen">

    <div class="title-box">
        <button type="button" class="title-button" data-year="1990">1990</button>
        <button type="button" class="title-button" data-year="2020">2020</button>
    </div>

</div>
<canvas id='display' width='1' height='1'></canvas>
<canvas id='status' width='1' height='1'></canvas>
<canvas id='minimap' width='1' height='1'></canvas>
<div class="info-ui">
    <div>
        <span>FPS:</span>
        <span class="fps-info">0</span>
    </div>
</div>
<script type="module" content="text/javascript">
  import engine from '../engine/src/index.js'

  const Status = engine.Status
  const Player = engine.Player
  const Controls = engine.Controls
  const Environment = engine.Environment
  const Map = engine.Map
  const Minimap = engine.Minimap
  const Camera = engine.Camera
  const GameLoop = engine.GameLoop
  const Texture = engine.Texture
  const RayCaster = engine.RayCaster
  const CanvasBuffer = engine.CanvasBuffer
  const Color = engine.Color
  /**
   * ---------------------------------------------------------
   * GET CANVAS ELEMENTS
   * ---------------------------------------------------------
   */

  const display = document.querySelector('#display')
  const minimapCanvas = document.querySelector('#minimap')
  const statusCanvas = document.querySelector('#status')

  /**
   * ---------------------------------------------------------
   * CONFIGURATIONS
   * ---------------------------------------------------------
   */

  const MOBILE = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)

  const cam1999 = {
    canvas: display,
    resolution: 320,
    focalLength: 0.8,
    canvasScale: 0.25,
    range: 14,
    isMobile: MOBILE
  }
  const cam2019 = {
    canvas: display,
    resolution: 1024,
    focalLength: 0.8,
    canvasScale: 1,
    range: 14,
    isMobile: MOBILE
  }

  const playerConfig = {
    x: 15.3,
    y: -1.2,
    health: 100,
    direction: Math.PI * 0.3,
    defaultSpeed: 1.8,
    runFactor: 1.8,
    sounds: [ {
      id: 'walk',
      url: 'assets/audio/steps.mp3'
    }, {
      id: 'run',
      url: 'assets/audio/steps_run.ogg'
    } ]
  }

  function getRandom (min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min
  }

  function getTextMetric (text, font) {
    let metrics = {}
    const metricsBuffer = new CanvasBuffer({})
    metricsBuffer.pre((ctx) => {
      // set font and measure width
      ctx.font = font
      metrics = ctx.measureText(text)
    })
    return metrics
  }

  function getMapDataFromText (text, fontSize) {
    const font = `${fontSize}px monospace`
    const metrics = getTextMetric(text, font)
    const width = Math.round(metrics.width)
    const height = fontSize
    const textBuffer = new CanvasBuffer({ width, height })

    textBuffer.pre((ctx) => {
      // set font and measure width
      ctx.font = font
      ctx.fillStyle = 'white'
      ctx.fillText(text, 0, height)
    })

    const imageData = textBuffer.ctx.getImageData(0, 0, width, height)
    const dataMap = []

    for (let i = 0; i < imageData.data.length; i += 4) {
      const r = imageData.data[ i ]
      const g = imageData.data[ i + 1 ]
      const b = imageData.data[ i + 2 ]
      const a = imageData.data[ i + 3 ]
      const value = (r + g + b + a) / (255 * 4)
      dataMap.push(value > 0 ? 1 : 0)
    }

    return { data: dataMap, width, height }
  }

  const skyBuffer = new CanvasBuffer({ width: window.innerWidth * 2, height: window.innerHeight * 2, alpha: false })
  skyBuffer.pre(context => {
    context.fillStyle = '#00010a'
    context.fillRect(0, 0, window.innerWidth * 2, window.innerHeight * 2)

    const stars = 2500
    const colorrange = [ 0, 60, 240 ]
    let y
    let radius
    let hue
    let sat
    for (let i = 0; i < stars; i++) {
      let x = Math.random() * window.innerWidth * 2
      y = Math.random() * window.innerHeight * 2
      radius = Math.random() * 1.2
      hue = colorrange[ getRandom(0, colorrange.length - 1) ]
      sat = getRandom(50, 100)
      context.beginPath()
      context.arc(x, y, radius, 0, 360)
      context.fillStyle = 'hsl(' + hue + ', ' + sat + '%, 88%)'
      context.fill()
    }
  })

  const wallBuffer = new CanvasBuffer({ width: 1024, height: 1024 })
  wallBuffer.pre((context) => {
    context.fillStyle = '#06ff00'
    context.fillRect(0, 0, 1024, 1024)

    const block = 32

    for (let x = 0; x < block; x++) {
      for (let y = 0; y < block; y++) {
        const value = 255 - Math.floor(Math.random() * 50)
        context.fillStyle = `rgb(
            ${value},
            ${value},
            ${value}
            )`
        context.fillRect(x * block, y * block, block, block)
      }
    }
  })

  const groundBuffer = new CanvasBuffer({ width: 1024, height: 1024 })
  groundBuffer.pre((context) => {
    context.fillStyle = '#b3b0b4'
    context.fillRect(0, 0, 1024, 1024)

    const block = 32

    for (let x = 0; x < block; x++) {
      for (let y = 0; y < block; y++) {
        const value = 255 - Math.floor(Math.random() * 50)
        context.fillStyle = `rgb(
            ${value},
            ${value},
            ${value}
            )`
        context.fillRect(x * block, y * block, block, block)
      }
    }
  })

  const envConfig = {
    sky: {
      texture: skyBuffer
    },
    wall: {
      textures: [
        wallBuffer
      ],
      color: '#399dff',
      border: {
        top: 1,
        left: 1,
        bottom: 1,
        right: 1
      }
    },
    ground: {
      texture: groundBuffer,
      color: '#0000FF'
    },
    rain: {
      amount: 1,
      sound: { id: 'rain', url: 'assets/audio/rain.ogg' }
    },
    thunder: {
      light: 2,
      sound: { id: 'thunder', url: 'assets/audio/thunder.ogg' }
    },
    ambient: {
      light: 5,
      sound: {
        id: 'ambient',
        url: 'assets/audio/ambient.mp3',
        listeners: {
          ended: () => {
            // play ambient after 15 seconds
            setTimeout(() => {
              environment.sounds.play('ambient', { volume: 0.8, loop: false })
            }, 15 * 1000)
          }
        }
      }
    }
  }

  /**
   * ---------------------------------------------------------
   * GAME SETUP
   * ---------------------------------------------------------
   */

  const environment = new Environment(envConfig)
  const player = new Player(playerConfig)

  const statusScreen = new Status({ canvas: statusCanvas })
  statusScreen.register(player)
  statusCanvas.addEventListener('click', function () {
    display.requestPointerLock = display.requestPointerLock || display.mozRequestPointerLock || display.webkitRequestPointerLock
    display.requestPointerLock()
  })

  let mouseCaptured = false

  document.addEventListener('pointerlockchange', function () {
    mouseCaptured = !mouseCaptured
    player.lockControls = !mouseCaptured
    document.body.style.cursor = mouseCaptured ? 'none' : 'pointer'
  })

  const mapConfig = getMapDataFromText('153', 18)
  const map = new Map(mapConfig)

  const rayCaster = new RayCaster(map)

  const loop = new GameLoop()
  const controls = new Controls()
  const miniMap = new Minimap({
    canvas: minimapCanvas,
    map: map,
    controls: controls,
    scale: 16,
    background: 'rgba(0,0,0,0)',
    wallColor: 'rgba(255, 255, 255, 0.4)',
    actorColor: 'rgba(0,255,0,0.7)'
  })

  player.on(Player.ON_DEAD, function (event) {
    loop.stop()
    alert('youre dead')
  })

  window.document.addEventListener('keydown', function (event) {
    if (event.code !== 'Space') return
    prompt('type in your solution', '')
  })

  const startButtons = document.querySelectorAll('.title-button')
  startButtons.forEach(button => button.addEventListener('click', function (event) {
    const dataSet = event.target.dataset
    const year = dataSet[ 'year' ]

    let camera
    if (year === '1990') camera = new Camera(cam1999)
    if (year === '2020') camera = new Camera(cam2019)

    // hide title screen
    const title = document.querySelector('.title-screen')
    title.style.display = 'none'

    display.requestPointerLock = display.requestPointerLock || display.mozRequestPointerLock || display.webkitRequestPointerLock
    display.requestPointerLock()

    // play rain immediately
    environment.sounds.play('rain', { volume: 0.8, loop: true })

    // play ambient after 15 seconds
    setTimeout(() => {
      environment.sounds.play('ambient', { volume: 0.8, loop: false })
    }, 15 * 1000)

    const actors = []

    function update (seconds) {
      // environment updates
      environment.update(seconds)

      // actors updates
      player.update(controls.states, map, seconds)
      actors.forEach(actor => actor.update({}, map, seconds))
      camera.update(controls.states, player, actors, rayCaster, seconds)

      // ui updates
      statusScreen.update(controls.states, seconds)
      miniMap.update(controls.states, player, seconds)
    }

    function render () {
      camera.render(player, environment, map, rayCaster)
      statusScreen.render()
      miniMap.render()
    }

    loop.start(update, render)
  }))

</script>
</body>
</html>
